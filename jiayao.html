<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>安定峰采购假药引发的惨案 VN风</title>
    <meta name="description" content="七九同人视觉小说">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.loli.net/css2?family=Inter:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-sc {
            font-family: 'Noto Serif SC', serif;
        }

        .font-calligraphy {
            font-family: 'Ma Shan Zheng', cursive;
        }

        /* 动画与特效 */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 500ms ease-in;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }

        .dialogue-glass {
            background: rgba(13, 13, 26, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid rgba(103, 232, 249, 0.3);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        }

        /* 滚动条 */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(103, 232, 249, 0.3);
            border-radius: 4px;
        }

        /* 角色立绘位置调整 */
        .char-sprite {
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3));
        }

        /* 移动端优化：确保全屏 */
        #app-root {
            height: 100vh;
            /* fallback */
            height: 100dvh;
        }

        /* 手机横屏专用样式 - 全局作用域 */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-landscape-title {
                font-size: 1.8rem !important;
                line-height: 1.2 !important;
            }

            .mobile-landscape-btn {
                padding-top: 0.3rem !important;
                padding-bottom: 0.3rem !important;
                font-size: 1rem !important;
            }

            .mobile-landscape-gap {
                gap: 0.5rem !important;
                margin-top: 0.5rem !important;
            }

            /* Ending Screen 特定样式 - 使用绝对定位布局避免弹性盒塌陷 */
            .ending-title-mobile-landscape {
                position: absolute !important;
                top: 0.5rem !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                font-size: 1.2rem !important;
                line-height: 1.1 !important;
                z-index: 10 !important;
            }

            .ending-text-mobile-landscape {
                position: absolute !important;
                top: 3rem !important;
                bottom: 3rem !important;
                left: 5% !important;
                width: 90% !important;
                margin: 0 !important;
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
                line-height: 1.5 !important;
                overflow-y: auto !important;
                max-height: none !important;
                flex-grow: 0 !important;
                height: auto !important;
                background: transparent !important;
                /* 透明背景 */
                border: none !important;
                /* 去除边框 */
                z-index: 10 !important;
                display: flex !important;
                align-items: center !important;
                /* 垂直居中 */
                justify-content: center !important;
                text-align: left !important;
                /* 水平左对齐 */
            }

            .ending-btn-mobile-landscape {
                position: absolute !important;
                bottom: 0.5rem !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                margin: 0 !important;
                font-size: 0.75rem !important;
                padding: 0.25rem 1.5rem !important;
                z-index: 10 !important;
                white-space: nowrap !important;
            }

            .ending-container-mobile-landscape {
                display: block !important;
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                justify-content: unset !important;
                align-items: unset !important;
            }

            /* 手机横屏：对话框进一步压缩 */
            .dialogue-glass {
                height: 4.8rem !important;
                /* Slightly increased height */
                padding: 0.4rem 0.6rem !important;
                /* Increased padding */
            }

            .dialogue-glass>div:first-child {
                padding-top: 0 !important;
            }

            .dialogue-glass p {
                font-size: 0.8rem !important;
                line-height: 1.3 !important;
                margin-top: -0.1rem !important;
            }

            /* 手机横屏：隐藏菜单文字 */
            .menu-label {
                display: none !important;
            }

            /* 手机横屏：音量按钮位置调整 */
            .volume-btn-mobile {
                top: 0.2rem !important;
                right: 0.2rem !important;
                padding: 0.25rem !important;
            }
        }
    </style>
</head>

<body class="text-slate-100 overflow-hidden">
    <div id="app-root"></div>

    <!-- 使用 ES Modules 直接加载 Preact 和 htm -->
    <script type="module">
        // 使用 esm.sh 确保依赖版本一致性和正确的 ESM 导出
        import { h, render, createContext } from 'https://esm.sh/preact@10.19.3';
        import { useState, useEffect, useRef, useMemo, useContext } from 'https://esm.sh/preact@10.19.3/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';

        const html = htm.bind(h);

        // --- 资源配置 (保持原资源) ---
        const ASSETS = {
            bg: {
                qingjing: './bk.JPG',
                qiancao: './qiancao.jpg',
                bamboo: './bamboonight.jpg',
                coldspring: './coldspring.jpg',
                bedroom: './bedroom.jpg',
                ruin: './ruin.jpg',
                lingxi: './lingxicave.jpg',
                nuanhong: './nuanhongge.jpg',
                start: './qijiu_start_screen (1).jpg',
                endingB: './Image (1).png'
            },
            char: {
                sqq: './shenqingqiu.png',
                yqy: './yueqingyuan.png'
            },
            audio: {
                bgm: './baheng.mp3',
                boom: './boom.mp3',
                fan: './fan.mp3',
                splash: './splash.mp3',
                cloth: './cloth.mp3',
                sword: './sword.mp3',
                magic: './magic.mp3',
                pipa: './pipa.mp3'
            }
        };

        // --- 剧本数据 (Structure Refined) ---
        const SCENES = {
            'chapter1': {
                lines: [
                    { speaker: '沈清秋', text: "（手中折扇“啪”地合上，眉间聚着戾气）没有？木师弟，你千草峰号称汇集天下灵药，如今我要能助我结丹突破的药，你却推三阻四？", mood: 'angry', bg: ASSETS.bg.qiancao, sound: ASSETS.audio.fan },
                    { speaker: '木清芳', text: "沈师兄，并非师弟不给。只是修行讲究循序渐进。若用猛药强行拔高，只怕欲速则不达。", mood: 'neutral' },
                    { speaker: '沈清秋', text: "（冷笑一声）欲速则不达？我看柳清歌精进神速，也没见他出什么岔子。怎么，他是天之骄子，我就是朽木一块？", mood: 'angry' },
                    { speaker: '木清芳', text: "（叹气，取出贴着符箓的青瓷小瓶）这是新炼的“固元紫金丹”。此药性烈，能短时间激发潜能……", mood: 'worried' },
                    { speaker: '木清芳', text: "不过师弟必须言明，这批药的几味辅料是安定峰新进的，尚师兄虽信誓旦旦说是上品，但我尚未完全验过药性……", mood: 'worried' },
                    { speaker: '沈清秋', text: "（一把夺过药瓶）够了。只要有用就行。", mood: 'angry' },
                    { speaker: '旁白', text: "他无法忍受同辈师兄弟都先他结丹。他要变强，哪怕饮鸩止渴。", mood: 'narrative' },
                    { speaker: '旁白', text: "夜深了，清静峰竹舍。竹林在风中沙沙作响。沈清秋屏退众弟子，设下两道禁制，仰头将那颗紫金丹药吞入腹中。", mood: 'narrative', bg: ASSETS.bg.bamboo },
                    { speaker: '沈清秋', text: "（闷哼一声，额头渗出冷汗）唔……", mood: 'pain' },
                    { speaker: '旁白', text: "那火没烧在经脉，全烧进了骨髓血液，直冲小腹，带着难以言喻又令人羞耻的燥热。", mood: 'narrative' },
                    { speaker: '沈清秋', text: "（蜷缩起身子，手指死抓身下竹席）该死……木清芳……尚清华……", mood: 'shame' },
                    { speaker: '旁白', text: "身体像被万蚁噬咬，又痒又痛，更可怕的是那种深处泛上来的空虚感。", mood: 'narrative' },
                    { speaker: '岳清源', text: "清秋师弟？我刚得了些极好的雨前龙井，想着你应该还没歇……", mood: 'gentle' },
                    { speaker: '沈清秋', text: "（浑身一僵，死死咬住嘴唇）（内心）岳清源。绝不能让他看见自己这副模样！绝不！滚……", mood: 'shame' },
                    { speaker: '岳清源', text: "（声音染上焦急）清秋师弟？你怎么了？我进来了！", mood: 'worried' },
                    { speaker: '旁白', text: "【音效】砰！灵力破门。", mood: 'system', sound: ASSETS.audio.boom },
                    { speaker: '岳清源', text: "（几步冲到榻前）这味道……合欢宗的千机散？！小九！", mood: 'shocked' },
                    { speaker: '沈清秋', text: "（眼神涣散，痛苦地撕扯领口）别……别碰我……", mood: 'shame' },
                ],
                next: 'chapter2'
            },
            'chapter2': {
                lines: [
                    { speaker: '旁白', text: "寒潭冷泉。岳清源抱着沈清秋跳入池中，试图帮他化解药性。然而一炷香过去，沈清秋体内热度未退，反因外界极寒刺激，逼得药性疯狂反扑。", mood: 'narrative', bg: ASSETS.bg.coldspring, sound: ASSETS.audio.splash },
                    { speaker: '沈清秋', text: "（猛地喷出一口鲜血）噗——", mood: 'pain' },
                    { speaker: '旁白', text: "眼角、鼻下、耳孔，竟都渗出了细细血丝。七窍流血。这是即将爆体而亡的征兆。", mood: 'narrative' },
                    { speaker: '岳清源', text: "（抱着他的手剧烈颤抖）（内心）冷泉没用。药太烈，已入骨髓。", mood: 'sorrow' },
                    { speaker: '岳清源', text: "（内心）若不疏解，小九会没命的。真的会死。", mood: 'sorrow' },
                ],
                next: 'choice1'
            },
            'choice1': {
                type: 'choice',
                bg: ASSETS.bg.coldspring,
                question: "岳清源看着痛苦万分的沈清秋，必须做出决定。",
                options: [
                    { id: 'A', text: "即使他会死，也不能趁人之危", next: 'endingBE1' },
                    { id: 'B', text: "恨我也好，杀我也罢，只要你活着", next: 'chapter3' }
                ]
            },
            'chapter3': {
                lines: [
                    { speaker: '岳清源', text: "（红着眼，将人猛地抱起）恨我也好，杀我也罢……只要你活着。", mood: 'dark', bg: ASSETS.bg.bedroom },
                    { speaker: '旁白', text: "掌门寝殿，结界落下。肌肤相亲瞬间，甜腻香气彻底引爆一切。沈清秋本能地将他当成唯一救赎，死死缠住岳清源脖颈。", mood: 'narrative' },
                    { speaker: '沈清秋', text: "（难受地蹭着，眼泪大颗滚落）……七哥……救我……七哥……好难受……", mood: 'shame' },
                    { speaker: '岳清源', text: "（眼底墨色翻涌）小九……七哥救你……七哥这就给你……", mood: 'dark' },
                    { speaker: '旁白', text: "衣衫尽裂，满室荒唐。这是一场名为救赎的凌迟。沈清秋在药力驱使下展现出从未见过的媚态，岳清源则在沈清秋一声声变调的“七哥”中，彻底疯魔。", mood: 'narrative', sound: ASSETS.audio.cloth },
                    { speaker: '旁白', text: "翌日清晨。寝殿一片狼藉。沈清秋在一阵酸痛中醒来，记忆如潮水回笼。", mood: 'narrative' },
                    { speaker: '沈清秋', text: "（看着身侧熟睡的岳清源，脸色惨白）（内心）太可笑了。太下贱了。", mood: 'despair' },
                    { speaker: '沈清秋', text: "（内心）昨晚那场荒唐中，我竟感到一丝满足。我竟然……还是爱着这个恨了半辈子的人。", mood: 'despair' },
                    { speaker: '沈清秋', text: "逃。", mood: 'despair' },
                    { speaker: '旁白', text: "沈清秋抓了件外袍，狼狈逃离苍穹山。", mood: 'system' },
                    { speaker: '岳清源', text: "（醒来面对空荡的怀抱，心头一慌）小九？", mood: 'worried' },
                    { speaker: '旁白', text: "没有。哪里都没有。岳清源看着满地狼藉——碎裂的青衫、染血锦被。他愿受这份恨，还以为只要负责，或许……可小九逃了。", mood: 'narrative' },
                    { speaker: '木清芳', text: "掌门师兄？今日怎么有空……", mood: 'neutral', bg: ASSETS.bg.qiancao },
                    { speaker: '岳清源', text: "（面色阴鸷）查！这到底是什么。（把丹药碎片扔到桌上）", mood: 'dark' },
                    { speaker: '木清芳', text: "（脸色煞白）掌……掌门师兄？这……主料没问题，但辅料“龙涎草”被换成了“合欢千叶红”！这是合欢宗流出的劣质催情辅料……是安定峰采购的。", mood: 'worried' },
                    { speaker: '岳清源', text: "（气极反笑，笑容渗人）省钱？传我掌门令。尚清华滥用职权，采购劣药，致同门受害，险酿大祸。", mood: 'dark' },
                    { speaker: '岳清源', text: "即日起，革去尚清华安定峰峰主半年俸禄，罚没私库充公。命他亲自清理那批劣药，一颗不许剩。", mood: 'dark' },
                    { speaker: '岳清源', text: "还有，禁足安定峰三个月，让他把以前所有账目重算一遍。若再有纰漏，我就让他去百战峰给柳师弟当陪练。", mood: 'determined' },
                    { speaker: '岳清源', text: "（抚摸着脖颈上的吻痕）小九……哪怕翻遍九州，我也要找到你。", mood: 'dark' },
                ],
                next: 'chapter4'
            },
            'chapter4': {
                lines: [
                    { speaker: '旁白', text: "离开苍穹山后，沈清秋像一缕不知归处的游魂。", mood: 'narrative', bg: ASSETS.bg.nuanhong },
                    { speaker: '旁白', text: "双脚似有自我意识，兜兜转转，终是回到了那座见证了他所有卑微与绝望的小城。", mood: 'narrative' },
                    { speaker: '旁白', text: "夜色如墨，勾栏瓦舍间笙歌曼舞。他踏入了一家名为“暖红阁”的青楼。", mood: 'narrative' },
                    { speaker: '沈清秋', text: "（随手掷下一锭银子，面容憔悴却难掩贵气）要最好的包间。找个琵琶技艺最精的姑娘来。", mood: 'disdain' },
                    { speaker: '旁白', text: "包间内，香气甜腻。", mood: 'narrative' },
                    { speaker: '琵琶女', text: "（见他衣着不凡，便想依偎上来）公子……奴家这就为您……", mood: 'neutral' },
                    { speaker: '沈清秋', text: "（冷声打断，侧身躺在软榻上，背对着她）离我远点。弹你的曲子。别说话，就这样。", mood: 'disdain' },
                    { speaker: '旁白', text: "【音效】琵琶声起，幽咽婉转。", mood: 'system', sound: ASSETS.audio.pipa },
                    { speaker: '沈清秋', text: "（闭上眼，呼吸渐渐平缓）（内心）这种脂粉气……甚至带着些许腐朽的味道……", mood: 'soft' },
                    { speaker: '沈清秋', text: "（内心）真奇怪。在清静峰闻惯了竹香墨香，如今闻到这股廉价的俗味，反倒莫名觉得心安。", mood: 'soft' },
                    { speaker: '沈清秋', text: "（内心）仿佛我从未上过苍穹山，从未做过高高在上的峰主。我依然是那个在泥沼里打滚，只配拥有这种廉价温柔的沈九。", mood: 'soft' },
                    { speaker: '沈清秋', text: "（嘴角勾起一抹自嘲的弧度）看啊，沈九，这才是你的归宿。烂泥，就该待在烂泥里。", mood: 'despair' },
                    { speaker: '旁白', text: "【闪回画面】昨夜岳清源深情的眼神，耳边的喘息。", mood: 'memory', bg: ASSETS.bg.bedroom },
                    { speaker: '沈清秋', text: "（指节猛地抓紧身下的锦褥）（内心）那夜的荒唐……不过是药力作祟。", mood: 'pain', bg: ASSETS.bg.nuanhong },
                    { speaker: '沈清秋', text: "（内心）是那伪君子不得不施舍的慈悲，是为了救一条狗命而不得已为之。", mood: 'pain' },
                    { speaker: '沈清秋', text: "（内心）可笑的是……你竟真的在那一刻动了心？竟真的在一声声“小九”里生出了满足？", mood: 'pain' },
                    { speaker: '沈清秋', text: "（将脸埋进臂弯，浑身轻颤）沈九……你当真贱入骨髓。连最后一点尊严，都要亲手碾碎。", mood: 'shame' },
                    { speaker: '旁白', text: "这一夜，他在琵琶声中彻夜未眠，任由心底的毒蛇将自己啃噬得鲜血淋漓。", mood: 'narrative' },
                    { speaker: '旁白', text: "天刚破晓，他推开那姑娘，扔下赏钱。满身萧索，走向城东那片焦黑的废墟。", mood: 'narrative' },
                ],
                next: 'chapter5'
            },
            'chapter5': {
                lines: [
                    { speaker: '旁白', text: "秋府废墟，焦黑的断壁。沈清秋像一缕游魂，兜兜转转回到了那片焦土废墟。", mood: 'narrative', bg: ASSETS.bg.ruin },
                    { speaker: '沈清秋', text: "（对着废墟嘶哑低吼）为什么……既当初弃我，如今又何必假惺惺来招惹！", mood: 'despair' },
                    { speaker: '岳清源', text: "（突然出现，扣住他的手腕）我不放。你还要躲到几时？", mood: 'sorrow' },
                    { speaker: '沈清秋', text: "（眼尾泛红，冷笑讥讽）岳掌门若怕我败坏苍穹山名声，大可清理门户！似我这般流连烟花柳巷之人，本来就脏……", mood: 'disdain' },
                    { speaker: '岳清源', text: "（一声暴喝）住口！你以为那晚是我救了你？小九，那是你在自救！", mood: 'dark' },
                    { speaker: '岳清源', text: "是你心里终于肯让我靠近，肯哭着喊我一声七哥……你逃根本不是因为恨我，你是恨你自己！", mood: 'dark' },
                    { speaker: '沈清秋', text: "（彻底崩溃）闭嘴……你闭嘴！！", mood: 'shame' },
                    { speaker: '岳清源', text: "（赤红着眼乞求）你若还有恨，拔出玄肃取我性命！只求你，别再作践你自己！", mood: 'sorrow' },
                ],
                next: 'choice2'
            },
            'choice2': {
                type: 'choice',
                bg: ASSETS.bg.ruin,
                question: "沈清秋的剑尖指着岳清源。",
                options: [
                    { id: 'A', text: "既然知道，那就去死！", next: 'chapter6' },
                    { id: 'B', text: "停手，转身离开", next: 'endingBE2' }
                ]
            },
            'chapter6': {
                lines: [
                    { speaker: '沈清秋', text: "既然知道，那就去死！！", mood: 'shame', bg: ASSETS.bg.ruin },
                    { speaker: '旁白', text: "【音效】嗡——！！！凄厉的剑鸣。血色灵光炸裂，进入记忆闪回。", mood: 'narrative', sound: ASSETS.audio.sword },
                    { speaker: '旁白', text: "剑锋即将贯穿胸膛的刹那，岳清源腰间玄肃剑骤然发出一声凄厉悲鸣！那非护主剑气，而是灵魂深处的共鸣与哀嚎。沈清秋的神识被强行拽入一片混沌的记忆之海。", mood: 'narrative', sound: ASSETS.audio.magic },
                    { speaker: '旁白', text: "【记忆闪回】“若无路可走，便以命开路。” 少年岳七以命入剑，口中溢血，却在笑：“小九……等我……七哥来了……”", mood: 'memory', bg: ASSETS.bg.lingxi },
                    { speaker: '沈清秋', text: "（冷汗湿透，跪倒在尘埃里）这剑鸣……直到这一刻，我才终于听懂了这句话……“拔出玄肃取我性命”。", mood: 'shocked', bg: ASSETS.bg.ruin },
                    { speaker: '沈清秋', text: "那不是一把剑，那是岳清源的命！", mood: 'shocked' },
                    { speaker: '旁白', text: "所有的怨恨、刻薄、自厌，在这份沉重窒息的真相面前，显得如此可笑苍白。", mood: 'narrative' },
                    { speaker: '岳清源', text: "（面色惨白，正欲转身离去）……", mood: 'sorrow' },
                    { speaker: '沈清秋', text: "（跌撞上前，死死扣住他的腰背，泪水汹涌）七哥……", mood: 'shocked' },
                    { speaker: '岳清源', text: "（浑身巨震，狠狠将怀中人揉进骨血）我在。小九，我们……回家。回苍穹山。", mood: 'gentle' },
                    { speaker: '旁白', text: "尘埃落定。尚清华被废去修为打入水牢。苍穹山夜色重归宁静。掌门寝殿，仍是那张床榻，气氛却截然不同。沈清秋体内余毒沉积，需靠双修化解。", mood: 'narrative', bg: ASSETS.bg.bedroom },
                    { speaker: '岳清源', text: "（手指轻抚他的眉眼）小九，可能会有点疼，忍一忍。", mood: 'gentle' },
                    { speaker: '沈清秋', text: "（睫毛颤了颤，耳根微红）啰嗦……快点。", mood: 'soft' },
                    { speaker: '旁白', text: "【CG】沈清秋仰起头，笨拙而坚定地吻上岳清源。", mood: 'narrative', bg: ASSETS.bg.endingB },
                    { speaker: '旁白', text: "那场由劣质丹药引发的烈火，曾差点将他们焚毁。可最终，这把火烧尽了所有的虚伪、隔阂与误解，将两颗早已千疮百孔的心，重新熔铸在了一起。", mood: 'narrative' },
                    { speaker: '旁白', text: "情不知所起，一往而深。恨不知所终，一笑而泯。", mood: 'narrative' },
                    { speaker: '系统', text: "【Happy End: 归途】", mood: 'success' },
                ],
                next: 'endingHE'
            },
            'endingHE': {
                type: 'ending',
                title: '归途',
                text: "",
                bg: ASSETS.bg.endingB
            },
            'endingBE1': {
                type: 'ending',
                title: '阴阳两隔',
                text: "岳清源最终没有越雷池一步。那一夜，沈清秋爆体而亡，岳清源走火入魔，苍穹山派双壁皆折。",
                bg: ASSETS.bg.coldspring
            },
            'endingBE2': {
                type: 'ending',
                title: '陌路',
                text: "沈清秋看着递过来的玄肃，冷笑一声，推开了岳清源的手。他转身走出废墟，从此修真界再无清静峰主，只有一个流浪的残废散修。岳清源守着苍穹山，孤独终老。",
                bg: ASSETS.bg.ruin
            }
        };

        // --- 组件 ---

        // 1. 图标库 (Lucide like)
        const Icon = ({ path, size = 24, className = "" }) => html`
            <svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=${className}>
                ${path}
            </svg>
        `;
        const Icons = {
            Menu: (p) => html`<${Icon} ...${p} path=${html`<line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" />`} />`,
            Volume2: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" />`} />`,
            VolumeX: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" />`} />`,
            Save: (p) => html`<${Icon} ...${p} path=${html`<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" />`} />`,
            Upload: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" />`} />`,
            RefreshCcw: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 12A9 9 0 0 0 6.19 6.19l-.78-.78" /><path d="M3 12a9 9 0 0 0 14.81 5.81l.78.78" /><path d="M2 17H6v4" /><path d="M22 7H18V3" />`} />`,
        };

        // 2. 加载页面
        const Preloader = ({ onLoadComplete }) => {
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                let loaded = 0;
                const total = Object.keys(ASSETS.bg).length + Object.keys(ASSETS.char).length;
                const images = [...Object.values(ASSETS.bg), ...Object.values(ASSETS.char)];

                if (images.length === 0) {
                    onLoadComplete();
                    return;
                }

                images.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = img.onerror = () => {
                        loaded++;
                        setProgress(Math.floor((loaded / total) * 100));
                        if (loaded === total) {
                            setTimeout(onLoadComplete, 500);
                        }
                    };
                });
            }, []);

            return html`
                <div class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center">
                    <div class="w-64 h-1 bg-slate-800 rounded-full overflow-hidden mb-4">
                        <div class="h-full bg-cyan-500 transition-all duration-300" style=${{ width: `${progress}%` }}></div>
                    </div>
                    <div class="text-slate-500 font-serif-sc tracking-widest text-sm animate-pulse">正在载入资源 ${progress}%</div>
                </div>
            `;
        };

        // 3. 对话框组件
        const DialogueBox = ({ speaker, text, onNext, isTyping, typingText, isNarrative }) => {
            // 颜色映射
            const getColors = (name) => {
                if (name === '沈清秋') return { text: 'text-emerald-300', border: 'border-emerald-600/50' };
                if (name === '岳清源') return { text: 'text-indigo-300', border: 'border-indigo-600/50' };
                if (name === '木清芳') return { text: 'text-green-200', border: 'border-green-600/50' };
                if (name === '系统') return { text: 'text-sky-300', border: 'border-sky-600/50' };
                if (name === '旁白') return { text: 'text-amber-200/80', border: 'border-amber-600/30' };
                return { text: 'text-slate-300', border: 'border-cyan-600/50' };
            };

            const colors = getColors(speaker);

            return html`
                <div class="w-full max-w-4xl mx-auto mb-1 px-4 z-30 select-none pb-1" onClick=${onNext}>
                    <div class="relative">
                        ${!isNarrative && html`
                            <div class="absolute bottom-full left-0 mb-0 px-3 py-1 bg-slate-900/90 border border-b-0 ${colors.border} rounded-t text-xs md:text-sm lg:text-lg font-bold ${colors.text} shadow-lg backdrop-blur-sm">
                                ${speaker}
                            </div>
                        `}
                        <div class="dialogue-glass rounded-lg md:rounded-xl p-1.5 md:p-4 lg:p-8 h-20 md:h-32 lg:h-52 hover:bg-slate-900/40 transition-colors cursor-pointer border ${colors.border} overflow-hidden flex flex-col relative">
                            <div class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent pr-1">
                                <p class="font-serif-sc text-xs md:text-lg lg:text-2xl leading-relaxed whitespace-pre-wrap ${isNarrative ? 'italic text-slate-300' : 'text-slate-100 font-bold'}">
                                    ${typingText}
                                    ${isTyping && html`<span class="inline-block w-1.5 h-4 md:w-2 md:h-5 bg-cyan-400 align-middle ml-1 animate-pulse"></span>`}
                                </p>
                            </div>
                            
                            ${!isTyping && html`
                                <div class="absolute bottom-1 right-2 md:bottom-2 md:right-4 lg:bottom-4 lg:right-6 animate-bounce text-cyan-500/50">
                                    <svg width="12" height="12" class="md:w-4 md:h-4 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-6-6h12z"/></svg>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        // 4. 开始画面
        const StartScreen = ({ onStart, onLoad, hasSave }) => html`
            <div class="absolute inset-0 z-40 bg-black flex flex-col items-center justify-center overflow-hidden">
                <div class="absolute inset-0 animate-in zoom-in duration-[10s]">
                    <img src=${ASSETS.bg.start} class="w-full h-full object-cover opacity-60" />
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/20 to-transparent"></div>
                
                <div class="relative z-50 text-center p-2 md:p-4 flex flex-col items-center gap-1 mobile-landscape-gap md:gap-4 lg:gap-8 animate-in fade-in slide-in-from-bottom-10 duration-1000">
                    <h1 class="font-calligraphy text-2xl mobile-landscape-title sm:text-3xl md:text-7xl text-slate-100 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] tracking-widest leading-relaxed">
                        安定峰采购假药<br/>引发的惨案
                    </h1>
                    
                    <div class="flex flex-col gap-2 mt-2 mobile-landscape-gap md:mt-4 lg:mt-8 w-full max-w-xs scale-90 md:scale-100">
                        <button onClick=${() => onStart()} class="px-4 py-1.5 mobile-landscape-btn md:px-8 md:py-3 bg-cyan-900/40 hover:bg-cyan-800/60 border border-cyan-500/30 text-cyan-100 text-lg md:text-2xl font-calligraphy rounded transition-all tracking-[0.2em] backdrop-blur-sm">
                            开始新游戏
                        </button>
                        ${hasSave && html`
                            <div class="flex gap-2 w-full">
                                <button onClick=${() => onLoad('auto')} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/40 hover:bg-slate-700/60 border border-slate-500/30 text-slate-300 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                    读取自动存档
                                </button>
                                <button onClick=${() => onLoad('manual')} class="flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/40 hover:bg-slate-700/60 border border-slate-500/30 text-slate-300 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                    读取手动存档
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;

        // 5. 选项组件
        const ChoiceScreen = ({ question, options, onChoice }) => html`
            <div class="absolute inset-0 z-40 bg-slate-950/80 backdrop-blur flex items-center justify-center p-2 md:p-4">
                <div class="max-w-4xl w-full md:w-fit bg-slate-900 border-2 border-red-900/50 p-2 md:p-4 lg:p-10 rounded-lg shadow-2xl animate-in zoom-in duration-300 flex flex-col justify-center max-h-full overflow-hidden">
                    <div class="text-red-500 font-bold mb-1 md:mb-2 lg:mb-6 text-center tracking-widest uppercase text-[10px] md:text-xl lg:text-2xl border-b border-red-900/30 pb-1 shrink-0">命运抉择</div>
                    <h2 class="text-xs md:text-base lg:text-2xl text-slate-200 font-serif-sc text-center mb-1 md:mb-2 lg:mb-10 leading-relaxed shrink-0">${question}</h2>
                    
                    <div class="grid grid-cols-2 gap-2 md:flex md:flex-col md:w-fit md:mx-auto md:gap-4 w-full overflow-y-auto custom-scroll pr-1">
                        ${options.map(opt => html`
                            <button onClick=${() => onChoice(opt)} class="group w-full text-left p-2 md:p-3 lg:p-5 border border-slate-700 hover:border-cyan-500 bg-slate-800/50 hover:bg-slate-700 transition-all rounded relative overflow-hidden flex flex-col justify-center min-h-[40px] md:min-h-[60px] lg:min-h-0">
                                <span class="relative z-10 text-[10px] md:text-sm lg:text-xl font-serif-sc leading-tight mb-0.5 md:mb-1 text-slate-200 group-hover:text-amber-100 transition-colors">${opt.text}</span>
                                ${opt.subtext && html`<div class="relative z-10 text-[8px] md:text-[10px] lg:text-xs text-slate-500 font-mono group-hover:text-cyan-400 leading-none">${opt.subtext}</div>`}
                                <div class="absolute inset-0 bg-cyan-900/10 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                            </button>
                        `)}
                    </div>
                </div>
            </div>
        `;

        // 6. 菜单组件
        const Menu = ({ onClose, onSave, onLoad, onBackTitle }) => html`
            <div class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick=${onClose}>
                <div class="bg-slate-900 border border-slate-700 p-4 md:p-8 rounded-xl shadow-2xl w-[260px] md:w-[320px] flex flex-col gap-2 md:gap-4 max-h-full overflow-y-auto custom-scroll" onClick=${e => e.stopPropagation()}>
                    <h3 class="text-cyan-400 text-lg md:text-xl font-bold mb-1 md:mb-2 text-center shrink-0">系统菜单</h3>
                    
                    <button onClick=${onSave} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-cyan-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-cyan-800 tracking-normal font-sans text-center font-bold shrink-0">
                        保存当前进度
                    </button>

                    <div class="h-px bg-slate-800 my-0 md:my-1 shrink-0"></div>

                     <button onClick=${() => onLoad('manual')} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-indigo-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-indigo-800 tracking-normal font-sans text-center font-bold shrink-0">
                        读取手动存档
                    </button>
                    
                     <button onClick=${() => onLoad('auto')} class="w-full p-3 md:p-4 bg-slate-800 hover:bg-indigo-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-indigo-800 tracking-normal font-sans text-center font-bold shrink-0">
                        读取自动存档
                    </button>

                    <div class="h-px bg-slate-800 my-0 md:my-1 shrink-0"></div>
                    
                    <button onClick=${onBackTitle} class="w-full p-3 md:p-4 bg-red-900/20 hover:bg-red-900/40 text-red-300 text-sm md:text-base rounded transition-colors tracking-normal font-sans text-center font-bold shrink-0">
                        返回标题
                    </button>
                </div>
            </div>
        `;

        // --- 主逻辑 ---
        const App = () => {
            const [isLoading, setIsLoading] = useState(true);
            const [gameState, setGameState] = useState({
                sceneId: 'start',
                lineIndex: 0,
                bg: ASSETS.bg.qingjing
            });
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [typingText, setTypingText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [bgmPlaying, setBgmPlaying] = useState(false);

            const audioRef = useRef(new Audio(ASSETS.audio.bgm));
            const timerRef = useRef(null);

            // 存档 Keys
            const MANUAL_SAVE_KEY = 'qijiu_manual_save';
            const AUTO_SAVE_KEY = 'qijiu_auto_save';

            // 播放 BGM
            useEffect(() => {
                const audio = audioRef.current;
                audio.loop = true;
                audio.volume = 0.4;
                // 移除 cleanup 以确保持续播放
                return () => { };
            }, []);

            const toggleAudio = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const audio = audioRef.current;

                // 以实际播放状态为准
                if (!audio.paused) {
                    audio.pause();
                    setBgmPlaying(false);
                } else {
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            setBgmPlaying(true);
                        }).catch(error => {
                            console.error("Audio play failed:", error);
                            setBgmPlaying(false);
                        });
                    }
                }
            };

            // 场景数据获取
            const currentScene = SCENES[gameState.sceneId];
            const currentLine = currentScene?.lines ? currentScene.lines[gameState.lineIndex] : null;

            // 打字机效果
            useEffect(() => {
                if (!currentLine) return;

                // 背景切换
                if (currentLine.bg) {
                    setGameState(prev => ({ ...prev, bg: currentLine.bg }));
                }

                // 音效播放
                if (currentLine.sound) {
                    const sfx = new Audio(currentLine.sound);
                    sfx.volume = 0.6;
                    sfx.play().catch(() => { });
                }

                // 文字打字
                const text = currentLine.text;
                setTypingText('');
                setIsTyping(true);
                let idx = 0;

                if (timerRef.current) clearInterval(timerRef.current);

                timerRef.current = setInterval(() => {
                    if (idx < text.length) {
                        setTypingText(text.substring(0, idx + 1));
                        idx++;
                    } else {
                        setIsTyping(false);
                        clearInterval(timerRef.current);
                    }
                }, 30); // 速度

                return () => clearInterval(timerRef.current);
            }, [gameState.lineIndex, gameState.sceneId]); // 依赖索引来触发

            // 自动存档逻辑
            useEffect(() => {
                if (gameState.sceneId !== 'start') {
                    localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify({
                        ...gameState,
                        timestamp: Date.now()
                    }));
                }
            }, [gameState]); // 每当 gameState 变化时触发

            const saveGame = () => {
                localStorage.setItem(MANUAL_SAVE_KEY, JSON.stringify({
                    ...gameState,
                    timestamp: Date.now()
                }));
                alert('手动存档成功');
                setIsMenuOpen(false);
            };

            const loadGame = (type = 'manual') => {
                try {
                    const key = type === 'auto' ? AUTO_SAVE_KEY : MANUAL_SAVE_KEY;
                    const savedStr = localStorage.getItem(key);

                    if (savedStr) {
                        const saved = JSON.parse(savedStr);
                        setGameState(saved);
                        setIsMenuOpen(false);
                    } else {
                        alert(type === 'auto' ? '暂无自动存档' : '暂无手动存档');
                    }
                } catch (e) { console.error(e); }
            };

            const handleNext = () => {
                if (isTyping) {
                    // 瞬间完成
                    clearInterval(timerRef.current);
                    setTypingText(currentLine.text);
                    setIsTyping(false);
                    return;
                }

                if (currentScene.lines) {
                    if (gameState.lineIndex < currentScene.lines.length - 1) {
                        setGameState(prev => ({ ...prev, lineIndex: prev.lineIndex + 1 }));
                    } else {
                        // 章节结束，跳转
                        if (currentScene.next) {
                            setGameState({
                                sceneId: currentScene.next,
                                lineIndex: 0,
                                bg: prevBg => SCENES[currentScene.next].type === 'choice' ? prevBg : (SCENES[currentScene.next].lines?.[0]?.bg || prevBg)
                            });
                        }
                    }
                }
            };

            const handleChoice = (option) => {
                setGameState({
                    sceneId: option.next,
                    lineIndex: 0,
                    bg: gameState.bg
                });
            };

            const renderContent = () => {
                if (gameState.sceneId === 'start') {
                    return html`<${StartScreen} 
                        onStart=${() => {
                            setGameState({ sceneId: 'chapter1', lineIndex: 0, bg: ASSETS.bg.qiancao });
                            // 用户交互后尝试播放音乐
                            audioRef.current.play().then(() => setBgmPlaying(true)).catch(() => { });
                        }} 
                        onLoad=${loadGame} 
                        hasSave=${!!(localStorage.getItem(MANUAL_SAVE_KEY) || localStorage.getItem(AUTO_SAVE_KEY))} 
                    />`;
                }

                if (currentScene?.type === 'choice') {
                    return html`<${ChoiceScreen} question=${currentScene.question} options=${currentScene.options} onChoice=${handleChoice} />`;
                }

                if (currentScene?.type === 'ending') {
                    return html`
                        <div class="absolute inset-0 flex items-center justify-center bg-black/80 z-40 p-2 md:p-8 text-center animate-in fade-in duration-1000">
                             <div class="ending-container-mobile-landscape max-w-3xl w-full h-full flex flex-col items-center justify-center relative">
                                <h1 class="ending-title-mobile-landscape text-3xl md:text-5xl font-calligraphy text-amber-500 mb-2 md:mb-6 tracking-widest drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] shrink-0">${currentScene.title}</h1>
                                ${currentScene.text && html`<p class="ending-text-mobile-landscape text-slate-300 text-sm md:text-xl leading-relaxed text-left mx-auto mb-4 md:mb-10 font-serif-sc p-4 md:p-6 bg-slate-900/50 rounded-lg border border-slate-700/50 overflow-y-auto">${currentScene.text}</p>`}
                                <button onClick=${() => setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.qingjing })} class="ending-btn-mobile-landscape px-6 py-2 md:px-10 md:py-3 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 border border-slate-500 text-slate-100 rounded text-base md:text-xl font-serif-sc tracking-widest shadow-lg transition-transform hover:scale-105 shrink-0">
                                    返回标题
                                </button>
                             </div>
                        </div>
                     `;
                }

                // 正常对话模式
                const speaker = currentLine?.speaker;
                const isSQQ = speaker === '沈清秋';
                const isYQY = speaker === '岳清源';
                const isNarrative = !speaker || speaker === '旁白';

                return html`
                    <!-- 立绘层: 仅在说话时显示 -->
                    <div class="absolute inset-0 z-10 flex items-end justify-center pointer-events-none">
                        <!-- 岳清源 -->
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-500 ease-out ${isYQY ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            <img src=${ASSETS.char.yqy} class="char-sprite absolute bottom-0 left-1/2 md:left-[40%] -translate-x-1/2 h-[85%] object-contain" />
                        </div>
                        <!-- 沈清秋 -->
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-500 ease-out ${isSQQ ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            <img src=${ASSETS.char.sqq} class="char-sprite absolute bottom-0 left-1/2 md:left-[60%] -translate-x-1/2 h-[85%] object-contain" />
                        </div>
                    </div>

                    <!-- 对话层 -->
                    <div class="absolute bottom-0 w-full z-30 pb-0">
                        <${DialogueBox} 
                            speaker=${speaker} 
                            text=${currentLine?.text} 
                            typingText=${typingText}
                            isTyping=${isTyping}
                            onNext=${handleNext} 
                            isNarrative=${isNarrative}
                        />
                    </div>

                    <!-- 顶部菜单按钮 (手机端仅图标) -->
                    <button onClick=${() => setIsMenuOpen(true)} class="absolute top-2 left-2 md:top-4 md:left-4 z-40 p-2 md:px-4 md:py-2 bg-slate-900/80 rounded-full hover:bg-slate-800 text-cyan-500 backdrop-blur border border-cyan-500/30 flex items-center gap-2 shadow-lg transition-all group highlight-none">
                        <${Icons.Menu} size=${18} />
                        <span class="menu-label font-bold text-sm group-hover:text-cyan-300 hidden md:inline">菜单</span>
                    </button>
                `;
            };

            return html`
                <div class="w-full h-full bg-black flex items-center justify-center overflow-hidden relative">
                    ${isLoading ? html`<${Preloader} onLoadComplete=${() => setIsLoading(false)} />` : null}
                    
                    <!-- 16:9 游戏容器 (使用 min() 动态计算确保完全适配屏幕) -->
                    <div class="relative shadow-2xl bg-slate-900 overflow-hidden m-auto group/game flex-shrink-0" 
                         style="width: min(100%, 177.78dvh); aspect-ratio: 16/9;">
                        
                        <!-- 动态背景 -->
                        <div class="absolute inset-0 z-0 transition-opacity duration-1000">
                            ${gameState.bg && html`<img src=${gameState.bg} class="w-full h-full object-cover filter brightness-[0.6]" />`}
                        </div>

                        <!-- UI 层 -->
                        ${renderContent()}

                        <!-- 全局音乐开关 (右上角更紧凑) -->
                        <button onClick=${toggleAudio} class="volume-btn-mobile absolute top-2 right-2 md:top-4 md:right-4 z-[60] p-2 md:p-3 text-cyan-500 hover:text-cyan-300 transition-all drop-shadow-lg hover:scale-110 active:scale-95" title="音乐开关">
                             ${bgmPlaying ? html`<${Icons.Volume2} size=${24} class="md:w-8 md:h-8 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />` : html`<${Icons.VolumeX} size=${24} class="md:w-8 md:h-8 text-slate-500 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />`}
                        </button>

                        <!-- 菜单模态框 -->
                        ${isMenuOpen && html`<${Menu}  
                            onClose=${() => setIsMenuOpen(false)} 
                            onSave=${saveGame} 
                            onLoad=${loadGame} 
                            onBackTitle=${() => {
                        setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.qingjing });
                        setIsMenuOpen(false);
                    }}
                        />`}
                    </div>
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app-root'));
    </script>
</body>

</html>