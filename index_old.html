<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²ˆæ¸…ç§‹ & å²³æ¸…æºï¼šé¦–å¸­å½“æ—¥ (VN é£æ ¼)</title>
    <!-- 1. åŠ è½½ Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ä½œä¸ºé»˜è®¤ï¼Œå¹¶å¼•å…¥è¡¬çº¿ä½“ç”¨äºå¯¹è¯æ–‡æœ¬ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Serif+SC:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0d0d1a; /* æ›´æ·±çš„èƒŒæ™¯ */
            /* ç¡®ä¿ body å’Œ html å æ®å…¨è§†å£é«˜åº¦ */
            width: 100vw;
            height: 100vh;
        }
        /* ç¡®ä¿æ ¹å…ƒç´ å æ®å…¨å± */
        #root {
            width: 100vw;
            height: 100vh;
        }
        .character-visual {
            /* ç¡®ä¿å›¾ç‰‡åœ¨å®¹å™¨å†…å®Œå…¨è¦†ç›–ï¼Œå¹¶é€‚é…ç«‹ç»˜çš„é•¿é«˜æ¯”ä¾‹ */
            object-fit: contain; /* ä½¿ç”¨ contain ç¡®ä¿ç«‹ç»˜å®Œæ•´æ˜¾ç¤º */
            width: 100%;
            height: 100%;
            /* ä¼˜åŒ–å›¾åƒè´¨é‡å’ŒåŠ è½½é€Ÿåº¦ */
            image-rendering: optimizeQuality;
        }

        /* ç»Ÿä¸€å¯¹è¯æ–‡æœ¬å­—ä½“ä¸ºè¡¬çº¿ä½“ */
        .dialogue-text {
            font-family: 'Noto Serif SC', serif;
        }
        
        /* å…³é”®ï¼šå¯¹è¯æ¡†çš„åŠé€æ˜èƒŒæ™¯å’ŒæŠ•å½± */
        .dialogue-box-container {
            /* æ¨¡æ‹Ÿ VN ç•Œé¢å¸¸è§çš„ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            background-color: rgba(13, 13, 26, 0.85); /* æ·±è‰²åŠé€æ˜ */
            backdrop-filter: blur(5px);
            border-top: 3px solid #67e8f9; /* äº®è‰²å¼ºè°ƒçº¿ */
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.5), 0 -2px 10px rgba(103, 232, 249, 0.2);
            transition: all 0.3s ease;
        }
        
        /* å…³é”®ï¼šå‘è¨€äººåç‰Œçš„æ ·å¼ */
        .speaker-tag {
            background-color: rgba(13, 13, 26, 0.95);
            border: 1px solid #67e8f9;
            box-shadow: 0 0 15px rgba(103, 232, 249, 0.15);
        }
    </style>
    
    <!-- 2. åŠ è½½ React, ReactDOM å’Œ Babel CDNs -->
    <!-- ä½¿ç”¨ React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. åŠ è½½ Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions to the global scope for use in the React script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, 
            setPersistence, browserSessionPersistence, enableIndexedDbPersistence
        };
    </script>
</head>
<body>
    <div id="root">
        <!-- React App will be mounted here -->
    </div>

    <!-- Firebase é…ç½®æ³¨å…¥åŒº -->
    <script>
      // âš ï¸ IMPORTANT: è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Firebase é…ç½®ä¿¡æ¯ï¼
      // å¦‚æœä¿æŒç°åœ¨çš„ "YOUR_API_KEY"ï¼Œæ¸¸æˆå°†è‡ªåŠ¨è¿›å…¥ç¦»çº¿æ¨¡å¼ã€‚
      window.__firebase_config = JSON.stringify({
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID" 
      });

      // é€‰å¡«ï¼šåŒºåˆ†åº”ç”¨/å­˜æ¡£çš„å”¯ä¸€ ID
      window.__app_id = "qijiu-game-1"; 
      
      // é€‰å¡«ï¼šå¦‚æœ Canvas æä¾›äº†è‡ªå®šä¹‰ Auth Tokenï¼Œè¯·å°†å…¶æ³¨å…¥
      // window.__initial_auth_token = "YOUR_CUSTOM_TOKEN";
    </script>

    <!-- 4. åµŒå…¥ JSX ä»£ç å¹¶ä½¿ç”¨ type="text/babel" å‘Šè¯‰ Babel è¿›è¡Œè½¬è¯‘ -->
    <script type="text/babel">
        // --- Icon Helpers (Lucide-React style) ---
        const Icon = ({ children, size = 24, className = 'text-current' }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const AlertTriangle = (props) => (
            <Icon {...props}>
                <path d="M10.29 3.86L2.39 20.34c-.21.46-.21.99 0 1.45.21.46.66.75 1.15.75h15.93c.49 0 .94-.29 1.15-.75.21-.46.21-.99 0-1.45L13.71 3.86c-.21-.46-.66-.75-1.15-.75s-.94.29-1.15.75z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </Icon>
        );
        
        const Heart = (props) => (
            <Icon {...props}>
                <path d="M19 14c1.49-1.46 3-3.23 3-5.5C22 6.07 19.93 4 17.5 4S13 7 13 7s-1.5-3-4.5-3C6.07 4 4 6.07 4 8.5c0 2.27 1.51 4.04 3 5.5l7 7 7-7z" />
            </Icon>
        );

        const RefreshCcw = (props) => (
            <Icon {...props}>
                <path d="M21 12A9 9 0 0 0 6.19 6.19l-.78-.78" />
                <path d="M3 12a9 9 0 0 0 14.81 5.81l.78.78" />
                <path d="M2 17H6v4" />
                <path d="M22 7H18V3" />
            </Icon>
        );
        
        const ShieldAlert = (props) => (
             <Icon {...props}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                <path d="M12 8v4" />
                <path d="M12 16h.01" />
            </Icon>
        );

        const Volume2 = (props) => (
             <Icon {...props}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
            </Icon>
        );

        const VolumeX = (props) => (
             <Icon {...props}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                <line x1="23" y1="9" x2="17" y2="15" />
                <line x1="17" y1="9" x2="23" y2="15" />
            </Icon>
        );

        const Save = (props) => (
            <Icon {...props}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </Icon>
        );
        
        const Upload = (props) => (
            <Icon {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </Icon>
        );

        const Menu = (props) => (
            <Icon {...props}>
                <line x1="3" y1="12" x2="21" y2="12" />
                <line x1="3" y1="6" x2="21" y2="6" />
                <line x1="3" y1="18" x2="21" y2="18" />
            </Icon>
        );
        
        // --- Core React Hooks & Firebase Setup ---
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc } = window.firebase;
        
        // **èµ„æº URL åˆ‡æ¢åŒº**
        // ---------------------------------------------------------------------------
        // ğŸ’¡ è°ƒè¯•è¯´æ˜ï¼š
        // 1. å¦‚æœä½ åœ¨ AI çš„ Preview çª—å£é‡Œçœ‹ï¼Œä½¿ç”¨ ã€é€‰é¡¹ A (CDN)ã€‘ï¼Œå¦åˆ™çœ‹ä¸åˆ°å›¾ã€‚
        // 2. å¦‚æœä½ è¦ Push åˆ° GitHub éƒ¨ç½²ç»™å›½å†…ç”¨æˆ·çœ‹ï¼Œä½¿ç”¨ ã€é€‰é¡¹ B (ç›¸å¯¹è·¯å¾„)ã€‘ã€‚
        // ---------------------------------------------------------------------------

        // ã€é€‰é¡¹ Aã€‘CDN é“¾æ¥ (åœ¨ Preview é‡Œä½¿ç”¨è¿™ä¸ªï¼)
        /*
        const BG_QINGJING = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/bk.JPG'; 
        const SHEN_QINGQIU_PIC = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/shenqingqiu.png'; 
        const YUE_QINGYUAN_PIC = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/yueqingyuan.png'; 
        const BGM_URL = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/baheng.mp3'; 
        const ENDING_B_PIC = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/Image.png';
        const START_SCREEN_PIC = 'https://cdn.jsdelivr.net/gh/HuihuiDreams/qijiu-game-1@main/qijiu_start_screen.png';
        */

        // ã€é€‰é¡¹ Bã€‘ç›¸å¯¹è·¯å¾„ (éƒ¨ç½²åˆ° Netlify æ—¶ï¼Œè¯·å–æ¶ˆä¸‹é¢æ³¨é‡Šï¼Œå¹¶æ³¨é‡Šæ‰ä¸Šé¢é‚£äº›ï¼)
        
        const BG_QINGJING = './bk.JPG'; 
        const SHEN_QINGQIU_PIC = './shenqingqiu.png'; 
        const YUE_QINGYUAN_PIC = './yueqingyuan.png'; 
        const BGM_URL = './baheng.mp3'; 
        const ENDING_B_PIC = './Image.png';
        const START_SCREEN_PIC = './qijiu_start_screen.png';
        
        
        // --- éŸ³ä¹æ§åˆ¶ Hook ---
        const useAudio = (url) => {
            const audioRef = React.useRef(new Audio(url));
            audioRef.current.loop = true;
            audioRef.current.volume = 0.5;

            const [isPlaying, setIsPlaying] = React.useState(false);
            
            const play = () => {
                if (!audioRef.current.src || audioRef.current.src === window.location.href) {
                     audioRef.current.src = url;
                }
                
                audioRef.current.play().then(() => {
                    setIsPlaying(true);
                }).catch(error => {
                    // console.error("Audio auto-play failed. User interaction needed.", error);
                    // é™é»˜å¤„ç†ï¼Œä¸æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨é»˜è®¤ä¸æ’­æ”¾
                    setIsPlaying(false);
                });
            };

            const pause = () => {
                audioRef.current.pause();
                setIsPlaying(false);
            };

            const toggle = () => {
                if (isPlaying) {
                    pause();
                } else {
                    play();
                }
            };

            React.useEffect(() => {
                audioRef.current.src = url;

                return () => {
                    audioRef.current.pause();
                    audioRef.current.removeAttribute('src');
                };
            }, [url]);

            return { isPlaying, play, pause, toggle };
        };


        // --- MAIN GAME COMPONENT ---
        const Game = () => {
            // --- Game State ---
            const [scene, setScene] = React.useState('start');
            const [dialogueIndex, setDialogueIndex] = React.useState(0);
            const [typedText, setTypedText] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [isMenuOpen, setIsMenuOpen] = React.useState(false);
            const [message, setMessage] = React.useState(null); 
            const [hasSave, setHasSave] = React.useState(false); 

            // --- Firebase State ---
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null); 
            const [isAuthReady, setIsAuthReady] = React.useState(false); 
            const [authStatusMessage, setAuthStatusMessage] = React.useState('ç­‰å¾…è®¤è¯...'); 
            const [isOfflineMode, setIsOfflineMode] = React.useState(false); // å…³é”®ï¼šæ–°å¢ç¦»çº¿æ¨¡å¼çŠ¶æ€
            
            const { isPlaying, play, toggle } = useAudio(BGM_URL);

            // --- Global Firebase Config ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // --- Game Data (Scenes) ---
            const scenes = {
                start: { id: 'start', bg: 'bg-slate-900', },
                dialogue: {
                    id: 'dialogue',
                    lines: [
                        { speaker: 'æ—ç™½', text: "  æ²ˆä¹è¢«èµåæ²ˆæ¸…ç§‹ï¼Œæˆä¸ºæ¸…é™å³°é¦–å¸­å½“å¤©ã€‚", mood: 'system' }, 
                        { speaker: 'æ—ç™½', text: "  æ˜¯å¤œã€‚æ²ˆä¹ç»ˆäºå¿™å®Œäº†ï¼Œå›åˆ°è‡ªå·±ä½å¤„ï¼Œå´çœ‹è§äº†æ­¤ç”Ÿæ— æ¯”åŒçƒ¦çš„ä¸€ä¸ªäººï¼Œå²³æ¸…æºã€‚", mood: 'narrative' },
                        { speaker: 'æ—ç™½', text: "  åŸæœ¬æ²ˆæ¸…ç§‹æ˜¯æƒ³ç›´æ¥å¿½è§†ä»–ç›´æ¥è¿›å±‹èˆä¼‘æ¯ï¼Œå¿™äº†ä¸€å¤©ï¼Œä»–å¾ˆç´¯äº†ã€‚", mood: 'narrative' },
                        { speaker: 'æ—ç™½', text: "  å³å°†æ“¦è‚©è€Œè¿‡çš„ä¸¤äººï¼Œè¿™æ—¶ï¼Œå²³æ¸…æºæ¡ä½äº†ä»–çš„æ‰‹ï¼Œæ²ˆæ¸…ç§‹çš±çœ‰ã€‚", mood: 'narrative' },
                        { speaker: 'æ²ˆæ¸…ç§‹', text: "  æ”¾å¼€ï¼Œæ¶å¿ƒã€‚", mood: 'angry' },
                        { speaker: 'å²³æ¸…æº', text: "  å°ä¹ï¼Œæˆ‘ä»¬ä¸€å®šè¦è¿™æ ·å—ï¼Ÿ", mood: 'sad' },
                        { speaker: 'æ²ˆæ¸…ç§‹', text: "  åˆ«å–Šé‚£ä¸ªåå­—ï¼æˆ‘ä»¬ä¸æ˜¯åº”è¯¥è¿™æ ·å—ï¼Ÿå²³æ¸…æºï¼æˆ‘ä»¬åªèƒ½è¿™æ ·...", mood: 'angry' },
                    ]
                },
                choice: {
                    id: 'choice',
                    question: "å‰§æƒ…åˆ†æ”¯ç‚¹ï¼šæ²ˆæ¸…ç§‹çš„æ€’ç«ç‡ƒçƒ§ï¼Œå²³æ¸…æºçš„é€‰æ‹©å°†å†³å®šä»–ä»¬çš„æœªæ¥ã€‚",
                    options: [
                        { id: 'A', text: "æ¾å¼€æ‰‹ï¼Œç•™ä¸‹å‰‘ç©—ï¼Œè½¬èº«ç¦»å¼€", subtext: "ï¼ˆç»“å±€ï¼šæ±‚è€Œä¸å¾— | æˆå°±ï¼šä¸€å¤œæ— çœ ï¼‰", style: "gray" },
                        { id: 'B', text: "ã€OOCå¼ºåˆ¶ä»‹å…¥ã€‘ç´§ç´§æŠ±ä½ï¼Œä»¥å»å°ç¼„", subtext: "ï¼ˆè§£é”ï¼šå²³ä¸ƒçš„ç–¯ç‹‚ | è­¦å‘Šï¼šå…³ç³»å€¼å‰§çƒˆæ³¢åŠ¨ï¼‰", style: "gold" }
                    ]
                },
                endingA: { id: 'endingA', text: "å²³æ¸…æºæ¾å¼€äº†æ²ˆæ¸…ç§‹çš„æ‰‹ï¼Œåœ¨ç¦»å¼€ä¹‹å‰ï¼Œå°†å‡†å¤‡å¥½çš„é¦–å¸­å¼Ÿå­ç¤¼â€”â€”ç«¹æŸå‰‘ç©—æ”¾åœ¨æ²ˆæ¸…ç§‹çš„å±‹é—¨å£ï¼Œç¦»å¼€äº†ã€‚æ²ˆæ¸…ç§‹åœ¨äººèµ°è¿œä¹‹åï¼Œæ‰æ‰“å¼€é—¨ï¼Œç«™äº†ä¸€å¤œã€‚ä½ è·å¾—äº†æˆå°±â€”â€”ä¸€å¤œæ— çœ ã€‚", mood: 'bad' },
                endingB: {
                    id: 'endingB',
                    lines: [
                        { speaker: 'æ—ç™½', text: "  å²³æ¸…æºåŸæœ¬è¦æ”¾å¼€çš„æ‰‹ï¼Œåœ¨æ¾å¼€çš„ç¬é—´ç´§ç´§ä»æ²ˆæ¸…ç§‹èº«åæŠ±ä½ä»–ã€‚", mood: 'narrative' },
                        { speaker: 'æ²ˆæ¸…ç§‹', text: "  ä½ åšä»€ä¹ˆï¼Ÿï¼æ”¾å¼€ï¼", mood: 'angry' },
                        { speaker: 'æ—ç™½', text: "  æ²ˆæ¸…ç§‹å¤§æ€’ï¼Œæ¨å¼€å²³æ¸…æºï¼Œæ‰‡äº†å²³æ¸…æºä¸€å·´æŒã€‚å²³æ¸…æºç¬‘äº†ä¸€å£°ï¼Œç¬¬ä¸€æ¬¡ç”¨çµåŠ›å‹åˆ¶æ²ˆæ¸…ç§‹ï¼Œåƒæ˜¯è¢«åˆºæ¿€åˆ°äº†ä»€ä¹ˆã€‚", mood: 'narrative' },
                        { speaker: 'æ—ç™½', text: "  ä»–ç‹ ç‹ å»äº†ä¸Šå»ï¼Œå µä½äº†é‚£å¼ è¯´ä¸å‡ºä¸€å¥è½¯è¯çš„å˜´ï¼Œä¹Ÿå µä½äº†è‡ªå·±è§£é‡Šçš„æœºä¼šã€‚", mood: 'narrative' },
                        { speaker: 'ç³»ç»Ÿ', text: "  ã€æ­å–œã€‘è¾¾æˆéšè—æˆå°±ï¼šå²³ä¸ƒçš„ç–¯ç‹‚ã€‚", mood: 'success' } 
                    ]
                }
            };

            // --- Firebase Initialization and Auth ---
            React.useEffect(() => {
                // å¦‚æœé…ç½®ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´ï¼Œç›´æ¥è¿›å…¥ç¦»çº¿æ¨¡å¼
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Detecting placeholder config. Switching to offline mode.");
                    setAuthStatusMessage('ç¦»çº¿æ¼”ç¤ºæ¨¡å¼ (æœªé…ç½®Firebase)');
                    setIsOfflineMode(true);
                    setIsAuthReady(true);
                    setUserId('offline_user');
                    return;
                }
                
                // 1. Initialize Firebase services
                const app = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(app);
                const firebaseAuth = getAuth(app);
                setDb(firestoreDb);
                setAuth(firebaseAuth);
                
                // 2. Set up Auth State Listener
                const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        console.log("User authenticated:", user.uid);
                        setUserId(user.uid);
                        if (!authStatusMessage.includes('å¤±è´¥') && isAuthReady) {
                             setAuthStatusMessage('è®¤è¯æˆåŠŸã€‚');
                        }
                    } else {
                        setUserId(null); 
                    }
                });

                // 3. Perform Initial Sign-In Attempt (Async)
                const authenticateAndSetReady = async () => {
                    let success = false;
                    setAuthStatusMessage('æ­£åœ¨å°è¯•è‡ªåŠ¨è®¤è¯...');
                    
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                            setAuthStatusMessage('å†…éƒ¨ä»¤ç‰Œè®¤è¯æˆåŠŸã€‚');
                            success = true;
                        } 
                    } catch (error) {
                        // ... error handling
                    }
                    
                    if (!success) {
                        try {
                            await signInAnonymously(firebaseAuth);
                            setAuthStatusMessage('åŒ¿åè®¤è¯æˆåŠŸã€‚');
                        } catch (error) {
                            console.error("Auth failed:", error);
                            // å…³é”®ï¼šå¦‚æœ API Key æ— æ•ˆï¼Œè‡ªåŠ¨é™çº§ä¸ºç¦»çº¿æ¨¡å¼
                            if (error.code === 'auth/api-key-not-valid' || error.message.includes('api-key-not-valid')) {
                                setAuthStatusMessage('ç¦»çº¿æ¨¡å¼ (Keyæ— æ•ˆ)');
                                setIsOfflineMode(true);
                                setUserId('offline_user');
                            } else {
                                setAuthStatusMessage(`è®¤è¯å¤±è´¥: ${error.code}`);
                            }
                        }
                    }
                    
                    setIsAuthReady(true);
                };

                authenticateAndSetReady();
                
                return () => unsubscribe();
            }, []);

            // --- Game State Persistence Functions (Firestore) ---
            const getSaveDocRef = () => {
                if (isOfflineMode || !db || !auth?.currentUser?.uid) return null;
                const currentUid = auth.currentUser.uid;
                return doc(db, 'artifacts', appId, 'users', currentUid, 'game_saves', 'current_game');
            };

            const displayMessage = (text, type = 'info', duration = 3000) => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), duration);
            };

            const saveGameState = async () => {
                if (isOfflineMode) {
                    displayMessage("ç¦»çº¿æ¨¡å¼æ— æ³•ä½¿ç”¨äº‘å­˜æ¡£ã€‚", 'warning');
                    return;
                }

                const saveDocRef = getSaveDocRef();
                if (!isAuthReady || !saveDocRef) {
                    displayMessage("é”™è¯¯ï¼šç”¨æˆ·æœªè®¤è¯æˆ–æ­£åœ¨åŠ è½½ã€‚", 'error');
                    return;
                }

                const gameState = {
                    scene: scene,
                    dialogueIndex: dialogueIndex,
                    timestamp: new Date().toISOString()
                };

                try {
                    await setDoc(saveDocRef, gameState);
                    displayMessage("å­˜æ¡£æˆåŠŸï¼å½“å‰è¿›åº¦å·²ä¿å­˜ã€‚", 'success');
                    setHasSave(true);
                } catch (e) {
                    console.error("Error saving document: ", e);
                    displayMessage("å­˜æ¡£å¤±è´¥ã€‚æƒé™ä¸è¶³æˆ–ç½‘ç»œé”™è¯¯ã€‚", 'error');
                }
            };

            const loadGameState = async () => {
                if (isOfflineMode) {
                    displayMessage("ç¦»çº¿æ¨¡å¼æ— æ³•è¯»å–äº‘å­˜æ¡£ã€‚", 'warning');
                    return;
                }

                const saveDocRef = getSaveDocRef();
                if (!isAuthReady || !saveDocRef) {
                    displayMessage("é”™è¯¯ï¼šç”¨æˆ·æœªè®¤è¯æˆ–æ­£åœ¨åŠ è½½ã€‚", 'error');
                    return;
                }

                try {
                    const docSnap = await getDoc(saveDocRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setScene(data.scene);
                        setDialogueIndex(data.dialogueIndex);
                        displayMessage("è¯»æ¡£æˆåŠŸï¼å·²æ¢å¤è¿›åº¦ã€‚", 'success');
                        
                        // FIX: è¯»å–å­˜æ¡£æ—¶ä¸è‡ªåŠ¨æ’­æ”¾éŸ³ä¹ï¼Œé˜²æ­¢å¡é¡¿
                        // if (!isPlaying) play(); 
                    } else {
                        displayMessage("æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£æ–‡ä»¶ã€‚", 'warning');
                        setHasSave(false);
                    }
                    setIsMenuOpen(false); 
                } catch (e) {
                    console.error("Error loading document: ", e);
                    displayMessage("è¯»æ¡£å¤±è´¥ã€‚æƒé™ä¸è¶³æˆ–ç½‘ç»œé”™è¯¯ã€‚", 'error');
                }
            };
            
            // Check for save existence (only if online)
            React.useEffect(() => {
                if (isAuthReady && db && auth && !isOfflineMode) {
                    const checkSave = async () => {
                        const saveDocRef = getSaveDocRef();
                        if (!saveDocRef) return;
                        
                        try {
                            const docSnap = await getDoc(saveDocRef);
                            setHasSave(docSnap.exists());
                        } catch(e) {
                            console.error("Save check error:", e);
                        }
                    };
                    checkSave();
                }
            }, [isAuthReady, db, auth, isOfflineMode]);


            // --- Game Flow Logic (Handle Next) ---
            
            // Typewriter Effect Logic
            React.useEffect(() => {
                let currentText = "";
                if (scene === 'dialogue') {
                    currentText = scenes.dialogue.lines[dialogueIndex].text;
                } else if (scene === 'endingB') {
                    currentText = scenes.endingB.lines[dialogueIndex].text;
                } else if (scene === 'endingA') {
                    currentText = scenes.endingA.text;
                } else {
                    return;
                }

                setTypedText('');
                setIsTyping(true);
                let i = 0;
                const speed = 30; 

                const timer = setInterval(() => {
                    if (i < currentText.length) {
                        setTypedText((prev) => prev + currentText.charAt(i));
                        i++;
                    } else {
                        setIsTyping(false);
                        clearInterval(timer);
                    }
                }, speed);

                return () => clearInterval(timer);
            }, [dialogueIndex, scene]);

            const handleNext = () => {
                if (isTyping) {
                    let fullText;
                    if (scene === 'dialogue') {
                        fullText = scenes.dialogue.lines[dialogueIndex].text;
                    } else if (scene === 'endingB') {
                        fullText = scenes.endingB.lines[dialogueIndex].text;
                    } else if (scene === 'endingA') {
                        fullText = scenes.endingA.text;
                    }
                    setTypedText(fullText);
                    setIsTyping(false);
                    return;
                }

                if (scene === 'dialogue') {
                    if (dialogueIndex < scenes.dialogue.lines.length - 1) {
                        setDialogueIndex(prev => prev + 1);
                    } else {
                        setScene('choice');
                    }
                } else if (scene === 'endingB') {
                    if (dialogueIndex < scenes.endingB.lines.length - 1) {
                        setDialogueIndex(prev => prev + 1);
                    }
                }
                // Ending A is handled directly by the component rendering and resetGame button.
            };

            const handleChoice = (option) => {
                if (option === 'A') {
                    setDialogueIndex(0); // Reset for endingA typewriter effect
                    setScene('endingA');
                } else {
                    setDialogueIndex(0);
                    setScene('endingB');
                }
            };

            const startGame = (load = false) => {
                if (load) {
                    loadGameState();
                } else {
                    setDialogueIndex(0);
                    setScene('dialogue');
                    // FIX: å¼€å§‹æ¸¸æˆæ—¶ä¸è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
                    // play();
                }
            }

            const resetGame = () => {
                setScene('start');
                setDialogueIndex(0);
                setIsMenuOpen(false);
            };

            // Helpers 
            const getSpeakerInfo = (speaker) => {
                let color = "text-slate-400";
                let tag = null;

                if (speaker === "æ²ˆæ¸…ç§‹") {
                    color = "text-emerald-300";
                    tag = "æ¸…é™å³°ä¸»";
                } else if (speaker === "å²³æ¸…æº") {
                    color = "text-indigo-300";
                    tag = "æŒé—¨å¸ˆå…„";
                } else if (speaker === "ç³»ç»Ÿ") {
                    color = "text-sky-300";
                    tag = "ç³»ç»Ÿæç¤º";
                } else if (speaker === "æ—ç™½") {
                    color = "text-amber-300";
                    tag = "æ—ç™½";
                } else if (speaker === "èƒŒæ™¯") {
                    color = "text-fuchsia-300";
                    tag = "åœºæ™¯è®¾ç½®";
                }
                
                return { name: speaker, color, tag };
            };

            // Dialogue Box Component (Simplified, removed Insight/TTS buttons)
            const DialogueBox = ({ line, typedText, isTyping, handleClick, isLastEndingBLine }) => {
                const { name, color } = getSpeakerInfo(line.speaker);
                const isNarrative = name === 'æ—ç™½' || name === 'èƒŒæ™¯' || name === 'ç³»ç»Ÿ';
                
                return (
                    <div className="relative w-full h-full">
                        {/* 1. å‘è¨€äººåç‰Œ */}
                        {!isNarrative && (
                            <div 
                                className={`speaker-tag absolute bottom-full left-0 mb-[-1px] rounded-t-lg px-4 py-2 text-base font-bold transition-colors ${color} `}
                                style={{ transform: 'translateY(-1px)' }}
                            >
                                {name}
                            </div>
                        )}

                        {/* 2. ä¸»å¯¹è¯æ¡†å®¹å™¨ */}
                        <div 
                            onClick={handleClick}
                            className={`dialogue-box-container p-6 relative h-full rounded-lg transition-all 
                                ${isLastEndingBLine ? 'cursor-default' : 'cursor-pointer hover:bg-opacity-95'}
                                ${isNarrative ? 'border-cyan-600/50' : ''} 
                                ${line.speaker === 'æ²ˆæ¸…ç§‹' ? 'border-emerald-600' : line.speaker === 'å²³æ¸…æº' ? 'border-indigo-600' : ''}
                            `}
                        >
                            {/* æ–‡æœ¬å†…å®¹ */}
                            <p 
                                className={`dialogue-text text-xl md:text-2xl leading-relaxed text-slate-100 ${isNarrative ? 'italic text-base md:text-xl text-slate-300' : 'font-semibold'}`}
                            >
                                {typedText}
                                {/* å…‰æ ‡ */}
                                {!isLastEndingBLine && (isTyping || typedText.length < line.text.length) && (
                                    <span className="animate-pulse inline-block ml-1 w-2 h-6 bg-cyan-400 align-middle"></span>
                                )}
                            </p>
                            
                            {/* "ç‚¹å‡»ç»§ç»­"æç¤º */}
                            {!isLastEndingBLine && !isTyping && typedText.length === line.text.length && (
                                <div className="absolute bottom-3 right-4 text-xs text-cyan-500 font-mono animate-bounce">
                                    ç‚¹å‡»ç»§ç»­ (â–¼)
                                </div>
                            )}
                        </div>
                    </div>
                );
            };
            
            // Floating Menu Component (Simplified, removed Insight/TTS buttons)
            const GameMenu = ({ isOpen, onClose, onSave, onLoad, onReset }) => {
                if (!isOpen) return null;

                return (
                    <div className="absolute inset-0 z-40 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center animate-in fade-in duration-300">
                        <div className="w-full max-w-sm bg-slate-900/95 border border-cyan-700 rounded-lg p-6 shadow-2xl space-y-4">
                            <h3 className="text-2xl font-bold text-cyan-400 mb-6 border-b border-cyan-800 pb-2">æ¸¸æˆèœå•</h3>
                            
                            <button onClick={onSave} className="w-full flex items-center justify-center gap-3 p-4 bg-cyan-700/30 hover:bg-cyan-600/50 text-white rounded-lg transition-all border border-cyan-600">
                                <Save size={20} /> äº‘ç«¯å­˜æ¡£
                            </button>
                            
                            <button onClick={onLoad} className="w-full flex items-center justify-center gap-3 p-4 bg-indigo-700/30 hover:bg-indigo-600/50 text-white rounded-lg transition-all border border-indigo-600">
                                <Upload size={20} /> äº‘ç«¯è¯»æ¡£
                            </button>

                            <button onClick={onReset} className="w-full flex items-center justify-center gap-3 p-4 bg-red-700/30 hover:bg-red-600/50 text-white rounded-lg transition-all border border-red-600">
                                <RefreshCcw size={20} /> ä»å¤´å¼€å§‹
                            </button>

                            <button onClick={onClose} className="w-full mt-6 p-3 bg-slate-700/50 hover:bg-slate-600/70 text-slate-300 rounded-lg transition-all">
                                è¿”å›æ¸¸æˆ
                            </button>
                        </div>
                    </div>
                );
            };

            // Status Message Toast
            const MessageToast = ({ message }) => {
                if (!message) return null;

                const baseStyle = "fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 transition-all duration-300 flex items-center gap-2";
                let style = "";
                let icon = null;

                switch (message.type) {
                    case 'success':
                        style = "bg-green-700 text-white border border-green-500";
                        icon = <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>;
                        break;
                    case 'error':
                        style = "bg-red-700 text-white border border-red-500";
                        icon = <AlertTriangle size={20} />;
                        break;
                    case 'warning':
                        style = "bg-yellow-700 text-yellow-100 border border-yellow-500";
                        icon = <ShieldAlert size={20} />;
                        break;
                    default:
                        style = "bg-slate-700 text-slate-200 border border-slate-500";
                        break;
                }

                return (
                    <div className={`${baseStyle} ${style}`}>
                        {icon}
                        <span className="font-semibold text-sm">{message.text}</span>
                    </div>
                );
            };

            return (
                // Outer Container: Full Screen, Center Content
                <div className="w-full h-screen bg-slate-950 text-cyan-50 font-sans overflow-hidden relative flex items-center justify-center select-none p-4">
                
                <MessageToast message={message} />
                
                {/* éŸ³ä¹æ§åˆ¶æŒ‰é’® - æµ®åŠ¨åœ¨å³ä¸‹è§’ (BGM Toggle) */}
                <button 
                    onClick={toggle}
                    className="absolute bottom-4 right-4 z-50 p-3 rounded-full bg-slate-800/70 text-cyan-500 hover:bg-slate-700/90 transition-all border border-cyan-800 shadow-lg"
                    title={isPlaying ? "æš‚åœèƒŒæ™¯éŸ³ä¹" : "æ’­æ”¾èƒŒæ™¯éŸ³ä¹"}
                >
                    {isPlaying ? <Volume2 size={24} /> : <VolumeX size={24} />}
                </button>
                
                {/* æ¸¸æˆèœå•æŒ‰é’® - æµ®åŠ¨åœ¨å·¦ä¸Šè§’ (ä»…åœ¨éå¼€å§‹/éç»“å±€ç”»é¢) */}
                {(scene !== 'start' && scene !== 'endingB') && (
                    <button 
                        onClick={() => setIsMenuOpen(true)}
                        className="absolute top-4 left-4 z-30 p-3 rounded-full bg-slate-800/70 text-cyan-500 hover:bg-slate-700/90 transition-all border border-cyan-800 shadow-lg"
                        title="æ¸¸æˆèœå•"
                    >
                        <Menu size={24} />
                    </button>
                )}


                {/* --- æ ¸å¿ƒæ¸¸æˆåŒºåŸŸ (16:9 æ¯”ä¾‹ï¼Œå±…ä¸­) --- */}
                <div id="game-frame" className="w-full h-full max-w-6xl mx-auto aspect-[16/9] relative overflow-hidden shadow-2xl rounded-xl">
                
                    {/* Background Effects (Relative to the 16:9 frame) */}
                    <div className="absolute inset-0 pointer-events-none opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-950 to-black"></div>
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>

                    {/* --- SCENE: START --- */}
                    {scene === 'start' && (
                        <div className="absolute inset-0 z-10 flex items-center justify-center">
                            {/* 1. Start Screen Image Background */}
                            <img 
                                src={START_SCREEN_PIC}
                                alt="æ¸¸æˆå¼€å§‹ç”»é¢"
                                className="absolute inset-0 w-full h-full object-cover transition-opacity duration-1000"
                                onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/1920x1080/0d0d1a/ffffff?text=æ¸¸æˆå¼€å§‹ç”»é¢"; e.target.className = "absolute inset-0 w-full h-full object-cover p-16" }}
                            />
                            
                            {/* 2. Overlay for readability */}
                            <div className="absolute inset-0 bg-black/50"></div>

                            {/* 3. Content Card (Z-index 20) */}
                            <div className="z-20 text-center space-y-6 animate-in fade-in zoom-in duration-700 p-8 rounded-lg bg-slate-900/80 backdrop-blur-md border border-cyan-700/50 shadow-2xl w-full max-w-sm">
                                <h1 className="text-5xl font-extrabold tracking-widest text-transparent bg-clip-text bg-gradient-to-b from-cyan-200 to-cyan-600 drop-shadow-lg pt-4">
                                    ã€ä¸ƒä¹åŒäººã€‘é¦–å¸­å½“æ—¥
                                </h1>
                                <p className="text-slate-400 text-sm max-w-xs mx-auto pt-2 border-t border-slate-700/50">
                                    åŠ è½½å‰§æœ¬ï¼šç”¨æˆ·åŸåˆ›åŒäººå‰§æœ¬<br/>
                                    {/* å¢å¼ºè®¤è¯è°ƒè¯•ä¿¡æ¯ */}
                                    ç”¨æˆ·IDçŠ¶æ€ï¼š<span 
                                        className={`font-mono text-xs ${userId ? 'text-sky-400' : (isAuthReady && !isOfflineMode) ? 'text-red-400' : 'text-yellow-400'}`}
                                    >
                                        {isAuthReady 
                                            ? (userId || authStatusMessage) 
                                            : authStatusMessage}
                                    </span>
                                </p>
                                <div className="space-y-4 pt-4">
                                    {/* åªæœ‰è®¤è¯æˆåŠŸï¼Œæ‰èƒ½å¼€å§‹æ¸¸æˆ */}
                                    <button 
                                        onClick={() => startGame(false)}
                                        disabled={!isAuthReady || !userId} 
                                        className={`w-full px-10 py-3 transition-all duration-300 rounded-lg text-lg font-mono tracking-widest uppercase shadow-xl 
                                            ${(isAuthReady && userId) ? 'bg-cyan-700/50 border border-cyan-400 hover:bg-cyan-500 hover:text-black hover:shadow-[0_0_25px_rgba(103,232,249,0.5)]' : 'bg-slate-700/50 border border-slate-600 text-slate-400 cursor-not-allowed'}
                                        `}
                                    >
                                        [ å¼€å§‹æ–°æ¸¸æˆ ]
                                    </button>
                                    
                                    {/* åªæœ‰è®¤è¯æˆåŠŸï¼Œæ‰èƒ½ç»§ç»­æ¸¸æˆ */}
                                    {hasSave && (
                                        <button 
                                            onClick={() => startGame(true)}
                                            disabled={!isAuthReady || !userId}
                                            className={`w-full px-10 py-3 bg-indigo-700/50 border border-indigo-400 hover:bg-indigo-500 hover:text-black transition-all duration-300 rounded-lg text-lg font-mono tracking-widest uppercase shadow-xl hover:shadow-[0_0_25px_rgba(129,140,248,0.5)] ${(isAuthReady && userId) ? '' : 'cursor-not-allowed opacity-50'}`}
                                        >
                                            [ ç»§ç»­æ¸¸æˆ ]
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- SCENE: DIALOGUE & ENDING B --- */}
                    {(scene === 'dialogue' || scene === 'endingB') && (() => {
                        const isLastEndingBLine = scene === 'endingB' && dialogueIndex === scenes.endingB.lines.length - 1;
                        const currentLines = scenes[scene]?.lines || [];
                        const currentLine = currentLines[dialogueIndex] || { speaker: '', text: '' };
                        
                        let textToDisplay = typedText;
                        const handleClick = isLastEndingBLine ? null : handleNext;
                        const speakingCharacter = currentLine.speaker;

                        return (
                            <div className="absolute inset-0 w-full h-full">
                            
                                {/* åœºæ™¯èƒŒæ™¯åŒºåŸŸ (å æ®å…¨éƒ¨ 16:9 ç©ºé—´) */}
                                <div className="absolute inset-0 rounded-xl overflow-hidden">
                                    {/* 1. Background Image */}
                                    <img 
                                        src={BG_QINGJING} 
                                        alt="Qingjing Peak Bamboo House Night Scene"
                                        className="absolute inset-0 w-full h-full object-cover transition-all duration-1000"
                                        style={{ filter: 'brightness(0.5) contrast(1.1)' }}
                                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/1280x720/101a2c/94a3b8?text=Placeholder+Background"; e.target.style.filter = "none"; e.target.className = "absolute inset-0 w-full h-full object-cover" }}
                                    />

                                    {/* 2. Night Overlay */}
                                    <div className="absolute inset-0 bg-slate-950/40"></div>
                                </div>


                                {/* 3. Character Visuals Area (Z-index 10) - å æ®é¡¶éƒ¨çº¦ 75% çš„é«˜åº¦ */}
                                <div className="absolute top-0 w-full h-[75%] flex items-end justify-center pt-16 gap-12">
                                    
                                    {/* Character 1 (Yue Qingyuan) */}
                                    <div className={`relative h-full transition-all duration-700 ${speakingCharacter === 'å²³æ¸…æº' ? 'scale-100 opacity-100 brightness-100' : 'scale-[0.98] opacity-60 brightness-75'} max-h-full w-1/3`}>
                                        <img 
                                            src={YUE_QINGYUAN_PIC} 
                                            alt="å²³æ¸…æº"
                                            className="character-visual absolute bottom-0 left-1/2 -translate-x-1/2"
                                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/300x500/292b6a/c7d2fe?text=å²³æ¸…æº+ç«‹ç»˜å ä½"; e.target.className = "character-visual p-8 object-contain" }}
                                        />
                                    </div>

                                    {/* Character 2 (Shen Qingqiu) */}
                                    <div className={`relative h-full transition-all duration-700 ${speakingCharacter === 'æ²ˆæ¸…ç§‹' ? 'scale-100 opacity-100 brightness-100' : 'scale-[0.98] opacity-60 brightness-75'} max-h-full w-1/3`}>
                                        <img 
                                            src={SHEN_QINGQIU_PIC} 
                                            alt="æ²ˆæ¸…ç§‹"
                                            className="character-visual absolute bottom-0 left-1/2 -translate-x-1/2"
                                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/300x500/065f46/d1fae5?text=æ²ˆæ¸…ç§‹+ç«‹ç»˜å ä½"; e.target.className = "character-visual p-8 object-contain" }}
                                        />
                                    </div>
                                </div>

                                {/* 4. å¯¹è¯æ¡† (å æ®åº•éƒ¨çº¦ 25% çš„é«˜åº¦) */}
                                <div className="absolute bottom-0 w-full h-[25%] px-4 md:px-8 pb-4 z-20">
                                    <DialogueBox 
                                        line={currentLine} 
                                        typedText={textToDisplay} 
                                        isTyping={isTyping} 
                                        handleClick={handleClick} 
                                        isLastEndingBLine={isLastEndingBLine} 
                                    />
                                </div>
                            </div>
                        );
                    })()}

                    {/* --- SCENE: CHOICE --- */}
                    {scene === 'choice' && (
                        <div className="z-20 absolute inset-0 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-6">
                        <div className="w-full max-w-2xl border-4 border-red-500/50 bg-slate-950 p-2 shadow-[0_0_50px_rgba(220,38,38,0.3)] animate-in zoom-in duration-300">
                            <div className="bg-slate-900 p-8 border border-red-900/30 relative overflow-hidden">
                                {/* Warning Header */}
                                <div className="flex items-center justify-center gap-4 text-red-400 mb-8 pb-4 border-b border-red-900/70">
                                    <AlertTriangle size={32} className="animate-pulse" />
                                    <h2 className="text-3xl font-extrabold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-red-200 to-red-600">
                                        å‘½è¿æŠ‰æ‹©
                                    </h2>
                                </div>
                                
                                <p className="text-slate-300 mb-10 text-lg text-center font-serif">
                                    {scenes.choice.question}
                                </p>

                                <div className="space-y-6">
                                    <button 
                                    onClick={() => handleChoice('A')}
                                    className="w-full text-left p-5 border border-slate-700 bg-slate-800/50 hover:bg-slate-700/70 transition-all duration-300 rounded text-lg font-semibold group relative overflow-hidden"
                                    >
                                        <div className="absolute inset-0 bg-slate-700/20 translate-y-[100%] group-hover:translate-y-0 transition-transform duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="text-slate-300 group-hover:text-white">A. {scenes.choice.options[0].text}</div>
                                            <div className="text-xs text-slate-500 mt-1 font-mono">{scenes.choice.options[0].subtext}</div>
                                        </div>
                                    </button>

                                    <button 
                                    onClick={() => handleChoice('B')}
                                    className="w-full text-left p-5 border-2 border-amber-500/70 bg-amber-950/30 hover:bg-amber-900/50 transition-all duration-300 rounded text-lg font-semibold group relative overflow-hidden shadow-lg"
                                    >
                                        <div className="absolute inset-0 bg-amber-500/10 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                                        <div className="relative z-10 flex justify-between items-center">
                                            <span className="text-amber-400 group-hover:text-amber-200">B. {scenes.choice.options[1].text}</span>
                                            <Heart size={20} className="text-red-500 animate-pulse" />
                                        </div>
                                        <div className="text-xs text-amber-600 mt-1 font-mono">{scenes.choice.options[1].subtext}</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* --- SCENE: ENDING A (BAD) --- */}
                    {scene === 'endingA' && (
                        <div className="z-10 absolute inset-0 flex items-center justify-center p-6">
                            <div className="text-center max-w-md animate-in fade-in duration-1000 p-8 rounded-lg bg-slate-900/80 border border-slate-700/50">
                                <ShieldAlert size={60} className="mx-auto text-slate-700 mb-6" />
                                <h2 className="text-3xl font-bold text-slate-500 mb-4">ç»“å±€è¾¾æˆ</h2>
                                <p className="text-slate-400 leading-relaxed mb-8 text-lg font-serif">
                                    {typedText}
                                </p>
                                <button 
                                    onClick={resetGame}
                                    className="flex items-center gap-2 mx-auto text-cyan-500 hover:text-cyan-300 transition-colors p-2 text-sm font-mono tracking-wider"
                                >
                                    <RefreshCcw size={16} />
                                    <span>è¯»æ¡£é‡æ¥ [RESTART]</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- SCENE: ENDING B (SUCCESS) - LAST FRAME --- */}
                    {scene === 'endingB' && dialogueIndex === scenes.endingB.lines.length - 1 && (
                        <div className="absolute inset-0 z-30 w-full flex items-center justify-center animate-in fade-in duration-1000">
                            {/* 1. å…¨å±ç»“å±€å›¾ */}
                            <img 
                                src={ENDING_B_PIC}
                                alt="ç»“å±€Bæ’å›¾"
                                className="absolute inset-0 w-full h-full object-cover transition-all duration-1000 brightness-100"
                                onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/1920x1080/1c0f0f/fcd34d?text=ç»“å±€æ’å›¾ç¼ºå¤±"; e.target.className = "absolute inset-0 w-full h-full object-cover p-16" }}
                            />

                            {/* 2. é»‘è‰²é®ç½©ï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */}
                            <div className="absolute inset-0 bg-black/30"></div>
                            
                            {/* 3. ç»“å±€æˆå°±æ–‡å­—å åŠ å±‚ */}
                            <div className="relative z-40 bg-gradient-to-r from-amber-900/50 to-yellow-900/50 border-2 border-amber-500 px-10 py-6 rounded-xl flex flex-col items-center gap-3 backdrop-blur-sm shadow-[0_0_50px_rgba(251,191,36,0.8)]">
                                <div className="w-4 h-4 bg-amber-400 rounded-full animate-ping"></div>
                                <span className="text-3xl font-extrabold text-amber-200 tracking-wider">ã€æ­å–œã€‘è¾¾æˆéšè—æˆå°±</span>
                                <span className="text-2xl text-amber-400 font-serif">å²³ä¸ƒçš„ç–¯ç‹‚ã€‚</span>
                                <span className="text-sm text-slate-500 pt-2">ç‚¹å‡»å³ä¸Šæ–¹åˆ·æ–°æŒ‰é’®é‡æ¥</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Ending B Reset Button (Only at very end) */}
                    {scene === 'endingB' && dialogueIndex === scenes.endingB.lines.length - 1 && (
                        <button 
                        onClick={resetGame}
                        className="absolute top-4 right-4 z-50 text-slate-600 hover:text-cyan-500 transition-colors p-2"
                        title="é‡æ–°å¼€å§‹"
                        >
                        <RefreshCcw size={24} />
                        </button>
                    )}

                </div>
                {/* --- æ ¸å¿ƒæ¸¸æˆåŒºåŸŸç»“æŸ --- */}

                {/* Game Menu Modal (Floating outside the 16:9 frame) */}
                <GameMenu 
                    isOpen={isMenuOpen} 
                    onClose={() => setIsMenuOpen(false)} 
                    onSave={saveGameState} 
                    onLoad={loadGameState} 
                    onReset={resetGame}
                />

                {/* Scanlines Overlay (Subtle effect) */}
                <div className="pointer-events-none absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%)] z-50 bg-[length:100%_2px] opacity-10"></div>
                </div>
            );
        };

        // 5. å¯åŠ¨ React åº”ç”¨
        window.addEventListener('load', () => {
            // ä½¿ç”¨ React 18 çš„ createRoot API
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<Game />);
        });
    </script>
</body>
</html>
